{
  "version": 3,
  "sources": ["https://deno.land/x/silverbullet@2.3.0/plug-api/lib/crypto.ts", "https://deno.land/x/silverbullet@2.3.0/client/lib/logger.ts", "https://deno.land/x/silverbullet@2.3.0/client/plugos/worker_runtime.ts", "proposal_editor.ts", "../../../../tmp/3c358110da8a2b10.js"],
  "sourcesContent": ["export function base64Decode(s: string): Uint8Array {\n  const binString = atob(s);\n  const len = binString.length;\n  const bytes = new Uint8Array(len);\n  for (let i = 0; i < len; i++) {\n    bytes[i] = binString.charCodeAt(i);\n  }\n  return bytes;\n}\n\nexport function base64Encode(buffer: Uint8Array | string): string {\n  if (typeof buffer === \"string\") {\n    buffer = new TextEncoder().encode(buffer);\n  }\n  let binary = \"\";\n  const len = buffer.byteLength;\n  for (let i = 0; i < len; i++) {\n    binary += String.fromCharCode(buffer[i]);\n  }\n  return btoa(binary);\n}\n\nexport function base64EncodedDataUrl(\n  mimeType: string,\n  buffer: Uint8Array,\n): string {\n  return `data:${mimeType};base64,${base64Encode(buffer)}`;\n}\n\nexport function base64DecodeDataUrl(dataUrl: string): Uint8Array {\n  const b64Encoded = dataUrl.split(\",\", 2)[1];\n  return base64Decode(b64Encoded);\n}\n\n/**\n * Perform sha256 hash using the browser's crypto APIs\n * Note: this will only work over HTTPS\n * @param message\n */\nexport async function hashSHA256(\n  message: string | Uint8Array,\n): Promise<string> {\n  // Transform the string into an ArrayBuffer\n  const encoder = new TextEncoder();\n  const data: Uint8Array = typeof message === \"string\"\n    ? encoder.encode(message)\n    : message;\n\n  // Generate the hash\n  const hashBuffer = await globalThis.crypto.subtle.digest(\n    \"SHA-256\",\n    data as BufferSource,\n  );\n\n  // Transform the hash into a hex string\n  return Array.from(new Uint8Array(hashBuffer)).map((b) =>\n    b.toString(16).padStart(2, \"0\")\n  ).join(\"\");\n}\n\n/**\n * To avoid database clashes based on space folder path name, base URLs and encryption keys we derive\n * a database name from a hash of all these combined together\n */\nexport async function deriveDbName(\n  type: \"data\" | \"files\",\n  spaceFolderPath: string,\n  baseURI: string,\n  encryptionKey?: CryptoKey,\n): Promise<string> {\n  let keyPart = \"\";\n  if (encryptionKey) {\n    keyPart = await exportKey(encryptionKey);\n  }\n  const spaceHash = await hashSHA256(\n    `${spaceFolderPath}:${baseURI}:${keyPart}`,\n  );\n  return `sb_${type}_${spaceHash}`;\n}\n\n// Fixed counter for AES-CTR all zeroes, for determinism\nconst fixedCounter = new Uint8Array(16);\n\nexport async function encryptStringDeterministic(\n  key: CryptoKey,\n  clearText: string,\n): Promise<string> {\n  const encrypted = await crypto.subtle.encrypt(\n    { name: \"AES-CTR\", counter: fixedCounter, length: fixedCounter.length * 8 },\n    key,\n    new TextEncoder().encode(clearText),\n  );\n  return base64Encode(new Uint8Array(encrypted));\n}\n\nexport async function decryptStringDeterministic(\n  key: CryptoKey,\n  cipherText: string,\n): Promise<string> {\n  const decrypted = await crypto.subtle.decrypt(\n    { name: \"AES-CTR\", counter: fixedCounter, length: fixedCounter.length * 8 },\n    key,\n    base64Decode(cipherText) as BufferSource,\n  );\n  return new TextDecoder().decode(decrypted);\n}\n\n// Encrypt using AES-GCM with random IV; output = IV + ciphertext\nexport async function encryptAesGcm(\n  key: CryptoKey,\n  data: Uint8Array,\n): Promise<Uint8Array> {\n  const iv = crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV recommended for GCM\n  const encryptedBuffer = await crypto.subtle.encrypt(\n    { name: \"AES-GCM\", iv },\n    key,\n    data as BufferSource,\n  );\n  const encrypted = new Uint8Array(encryptedBuffer);\n\n  // Prepend IV to ciphertext\n  const result = new Uint8Array(iv.length + encrypted.length);\n  result.set(iv, 0);\n  result.set(encrypted, iv.length);\n  return result;\n}\n\n// Decrypt using AES-GCM assuming input format IV + ciphertext\nexport async function decryptAesGcm(\n  key: CryptoKey,\n  encryptedData: Uint8Array,\n): Promise<Uint8Array> {\n  const iv = encryptedData.slice(0, 12); // extract IV (first 12 bytes)\n  const ciphertext = encryptedData.slice(12);\n  const decryptedBuffer = await crypto.subtle.decrypt(\n    { name: \"AES-GCM\", iv },\n    key,\n    ciphertext,\n  );\n  return new Uint8Array(decryptedBuffer);\n}\n\nexport async function deriveCTRKeyFromPassword(\n  password: string,\n  salt: Uint8Array,\n): Promise<CryptoKey> {\n  // Encode password to ArrayBuffer\n  const passwordBytes = new TextEncoder().encode(password);\n\n  // Import password as a CryptoKey\n  const baseKey = await crypto.subtle.importKey(\n    \"raw\",\n    passwordBytes,\n    { name: \"PBKDF2\" },\n    false,\n    [\"deriveBits\", \"deriveKey\"],\n  );\n\n  return crypto.subtle.deriveKey(\n    {\n      name: \"PBKDF2\",\n      salt: salt as BufferSource,\n      iterations: 100000,\n      hash: \"SHA-256\",\n    },\n    baseKey,\n    {\n      name: \"AES-CTR\",\n      length: 256,\n    },\n    true, // extractable\n    [\"encrypt\", \"decrypt\"],\n  );\n}\n\nexport function importKey(b64EncodedKey: string): Promise<CryptoKey> {\n  return crypto.subtle.importKey(\n    \"raw\",\n    base64Decode(b64EncodedKey) as BufferSource,\n    { name: \"AES-CTR\" },\n    true,\n    [\"encrypt\", \"decrypt\"],\n  );\n}\n\nexport async function exportKey(ctrKey: CryptoKey): Promise<string> {\n  const key = await crypto.subtle.exportKey(\"raw\", ctrKey);\n  return base64Encode(new Uint8Array(key));\n}\n\nexport async function deriveGCMKeyFromCTR(\n  ctrKey: CryptoKey,\n): Promise<CryptoKey> {\n  const rawKey = await crypto.subtle.exportKey(\"raw\", ctrKey);\n  return crypto.subtle.importKey(\n    \"raw\",\n    rawKey,\n    { name: \"AES-GCM\" },\n    true,\n    [\"encrypt\", \"decrypt\"],\n  );\n}\n", "// Logger that monkey patches console methods with prefixes and can capture logs for server transmission\n\nexport interface LogEntry {\n  level: \"log\" | \"info\" | \"warn\" | \"error\" | \"debug\";\n  timestamp: number;\n  message: string;\n}\n\nexport class Logger {\n  private originalConsole: {\n    log: typeof console.log;\n    info: typeof console.info;\n    warn: typeof console.warn;\n    error: typeof console.error;\n    debug: typeof console.debug;\n  };\n  public logBuffer: LogEntry[] = [];\n\n  constructor(\n    private prefix: string = \"\",\n    private maxCaptureSize: number = 1000,\n  ) {\n    this.prefix = prefix;\n\n    // Store original console methods\n    this.originalConsole = {\n      log: console.log.bind(console),\n      info: console.info.bind(console),\n      warn: console.warn.bind(console),\n      error: console.error.bind(console),\n      debug: console.debug.bind(console),\n    };\n\n    this.patchConsole();\n  }\n\n  private patchConsole(): void {\n    const createPatchedMethod = (level: keyof typeof this.originalConsole) => {\n      return (...args: any[]) => {\n        const prefixedArgs = this.prefix ? [this.prefix, ...args] : args;\n\n        // Call original console method\n        this.originalConsole[level](...prefixedArgs);\n\n        // Capture log if capturing is enabled\n        this.captureLog(level, args);\n      };\n    };\n\n    console.log = createPatchedMethod(\"log\");\n    console.info = createPatchedMethod(\"info\");\n    console.warn = createPatchedMethod(\"warn\");\n    console.error = createPatchedMethod(\"error\");\n    console.debug = createPatchedMethod(\"debug\");\n  }\n\n  private captureLog(level: LogEntry[\"level\"], args: any[]): void {\n    const entry: LogEntry = {\n      level,\n      timestamp: Date.now(),\n      message: args.map((arg) => {\n        if (typeof arg === \"string\") {\n          return arg;\n        }\n        try {\n          return JSON.stringify(arg);\n        } catch {\n          // Handle circular references or other JSON.stringify failures\n          return String(arg);\n        }\n      }).join(\" \"),\n    };\n\n    this.logBuffer.push(entry);\n\n    // Maintain max capture size by removing oldest entries\n    if (this.logBuffer.length > this.maxCaptureSize) {\n      this.logBuffer.shift();\n    }\n  }\n\n  /**\n   * Posts all buffered logs to a server endpoint\n   */\n  async postToServer(logEndpoint: string, source: string) {\n    const logs = this.logBuffer;\n    if (logs.length > 0) {\n      // Flush the buffer\n      const logCopy = [...this.logBuffer];\n      this.logBuffer = [];\n      try {\n        const resp = await fetch(logEndpoint, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify(logCopy.map((entry) => ({ ...entry, source }))),\n        });\n        if (!resp.ok) {\n          throw new Error(\"Failed to post logs to server\");\n        }\n      } catch (e: any) {\n        console.warn(\"Could not post logs to server\", e.message);\n        // Put back the logs into the buffer\n        this.logBuffer.unshift(...logCopy);\n      }\n    }\n  }\n}\n\n// Global logger instance\nlet globalLogger: Logger | undefined = undefined;\n\nexport function initLogger(prefix: string = \"\"): Logger {\n  globalLogger = new Logger(prefix);\n  return globalLogger;\n}\n", "// This is the runtime imported from the compiled plug worker code\nimport type { ControllerMessage, WorkerMessage } from \"./protocol.ts\";\nimport type {\n  ProxyFetchRequest64,\n  ProxyFetchResponse64,\n} from \"./proxy_fetch.ts\";\nimport { base64Decode, base64Encode } from \"../../plug-api/lib/crypto.ts\";\nimport { initLogger } from \"../lib/logger.ts\";\n\ndeclare global {\n  function syscall(name: string, ...args: any[]): Promise<any>;\n}\n\nlet workerPostMessage = (_msg: ControllerMessage): void => {\n  throw new Error(\"Not initialized yet\");\n};\n\n// Are we running in a (web) worker?\n\n// Determines if we're running in a web worker environment (Deno or browser)\n// - in a browser's main threads, typeof window is \"object\"\n// - in a browser's worker threads, typeof window === \"undefined\"\n// - in Deno's main thread typeof window === \"object\"\n// - in Deno's workers typeof window === \"undefined\n// - in Cloudflare workers typeof window === \"undefined\", but typeof globalThis.WebSocketPair is defined\nconst runningAsWebWorker = typeof window === \"undefined\" &&\n  // @ts-ignore: globalThis\n  typeof globalThis.WebSocketPair === \"undefined\";\n\nif (typeof Deno === \"undefined\") {\n  // @ts-ignore: Deno hack\n  self.Deno = {\n    args: [],\n    // @ts-ignore: Deno hack\n    build: {\n      arch: \"x86_64\",\n    },\n    env: {\n      // @ts-ignore: Deno hack\n      get() {\n      },\n    },\n  };\n}\n\nconst pendingRequests = new Map<\n  number,\n  {\n    resolve: (result: unknown) => void;\n    reject: (e: any) => void;\n  }\n>();\n\nlet syscallReqId = 0;\n\nif (runningAsWebWorker) {\n  globalThis.syscall = async (name: string, ...args: any[]) => {\n    return await new Promise((resolve, reject) => {\n      syscallReqId++;\n      pendingRequests.set(syscallReqId, { resolve, reject });\n      workerPostMessage({\n        type: \"sys\",\n        id: syscallReqId,\n        name,\n        args,\n      });\n    });\n  };\n}\n\nexport function setupMessageListener(\n  // deno-lint-ignore ban-types\n  functionMapping: Record<string, Function>,\n  manifest: any,\n  postMessageFn: (msg: ControllerMessage) => void,\n) {\n  if (!runningAsWebWorker) {\n    // Don't do any of this stuff if this is not a web worker\n    // This caters to the NoSandbox run mode\n    return;\n  }\n  workerPostMessage = postMessageFn;\n  self.addEventListener(\"message\", (event: { data: WorkerMessage }) => {\n    (async () => {\n      const data = event.data;\n      switch (data.type) {\n        case \"inv\":\n          {\n            const fn = functionMapping[data.name!];\n            if (!fn) {\n              throw new Error(`Function not loaded: ${data.name}`);\n            }\n            try {\n              const result = await Promise.resolve(fn(...(data.args || [])));\n              workerPostMessage({\n                type: \"invr\",\n                id: data.id,\n                result: result,\n              } as ControllerMessage);\n            } catch (e: any) {\n              console.error(\n                \"An exception was thrown as a result of invoking function\",\n                data.name,\n                \"error:\",\n                e.message,\n              );\n              workerPostMessage({\n                type: \"invr\",\n                id: data.id!,\n                error: e.message,\n              });\n            }\n          }\n          break;\n        case \"sysr\":\n          {\n            const syscallId = data.id;\n            const lookup = pendingRequests.get(syscallId);\n            if (!lookup) {\n              throw Error(\"Invalid request id\");\n            }\n            pendingRequests.delete(syscallId);\n            if (data.error) {\n              lookup.reject(new Error(data.error));\n            } else {\n              lookup.resolve(data.result);\n            }\n          }\n\n          break;\n      }\n    })().catch(console.error);\n  });\n  // Signal initialization with manifest\n  workerPostMessage({\n    type: \"manifest\",\n    manifest,\n  });\n  initLogger(`[${manifest.name} plug]`);\n}\n\nexport async function sandboxFetch(\n  reqInfo: RequestInfo,\n  options?: ProxyFetchRequest64,\n): Promise<ProxyFetchResponse64> {\n  if (typeof reqInfo !== \"string\") {\n    const body = new Uint8Array(await reqInfo.arrayBuffer());\n    const encodedBody = body.length > 0 ? base64Encode(body) : undefined;\n    options = {\n      method: reqInfo.method,\n      headers: Object.fromEntries(reqInfo.headers.entries()),\n      base64Body: encodedBody,\n    };\n    reqInfo = reqInfo.url;\n  }\n  return syscall(\"sandboxFetch.fetch\", reqInfo, options);\n}\n\n// @ts-ignore: monkey patching fetch\nglobalThis.nativeFetch = globalThis.fetch;\n\n// Monkey patch fetch()\nexport function monkeyPatchFetch() {\n  // @ts-ignore: monkey patching fetch\n  globalThis.fetch = async function (\n    reqInfo: RequestInfo,\n    init?: RequestInit,\n  ): Promise<Response> {\n    const encodedBody = init && init.body\n      ? base64Encode(\n        new Uint8Array(await (new Response(init.body)).arrayBuffer()),\n      )\n      : undefined;\n    const r = await sandboxFetch(\n      reqInfo,\n      init && {\n        method: init.method,\n        headers: init.headers as Record<string, string>,\n        base64Body: encodedBody,\n      },\n    );\n    // Casting the response to \"any\" for now, since of weird Deno typing\n    return new Response(\n      (r.base64Body ? base64Decode(r.base64Body) : null) as any,\n      {\n        status: r.status,\n        headers: r.headers,\n      },\n    );\n  };\n}\n\nif (runningAsWebWorker) {\n  monkeyPatchFetch();\n}\n", "/**\n * Document Editor for .proposal files\n *\n * Renders an inline diff view showing the proposed changes compared to the\n * original page content. Provides Accept/Reject buttons for user action.\n */\n\nexport async function editor(): Promise<{ html: string }> {\n  return {\n    html: `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    * {\n      box-sizing: border-box;\n    }\n    body {\n      margin: 0;\n      font-family: system-ui, -apple-system, sans-serif;\n      background: var(--root-background, #fff);\n      color: var(--root-color, #333);\n      line-height: 1.5;\n    }\n    .header {\n      padding: 16px;\n      border-bottom: 1px solid var(--ui-border, #ddd);\n      background: var(--ui-background, #f8f9fa);\n    }\n    .title {\n      font-size: 18px;\n      font-weight: bold;\n      margin-bottom: 4px;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .title-icon {\n      font-size: 24px;\n    }\n    .target {\n      color: var(--text-secondary, #666);\n      font-size: 14px;\n    }\n    .target a {\n      color: var(--link-color, #0066cc);\n      text-decoration: none;\n    }\n    .target a:hover {\n      text-decoration: underline;\n    }\n    .description {\n      margin-top: 8px;\n      font-style: italic;\n      color: var(--text-secondary, #666);\n    }\n    .metadata {\n      margin-top: 8px;\n      font-size: 12px;\n      color: var(--text-muted, #999);\n    }\n    .new-page-banner {\n      background: #dbeafe;\n      color: #1e40af;\n      padding: 8px 16px;\n      font-weight: 500;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .diff {\n      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;\n      font-size: 13px;\n      padding: 16px;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      line-height: 1.6;\n      overflow-x: auto;\n    }\n    .diff-line {\n      padding: 2px 8px;\n      margin: 0 -8px;\n    }\n    .diff-add {\n      background: #dcfce7;\n      color: #166534;\n    }\n    .diff-add::before {\n      content: \"+ \";\n      font-weight: bold;\n    }\n    .diff-del {\n      background: #fee2e2;\n      color: #991b1b;\n      text-decoration: line-through;\n    }\n    .diff-del::before {\n      content: \"- \";\n      font-weight: bold;\n    }\n    .diff-context {\n      color: var(--text-secondary, #666);\n    }\n    .diff-context::before {\n      content: \"  \";\n    }\n    .diff-separator {\n      color: var(--text-muted, #999);\n      background: var(--ui-background, #f8f9fa);\n      padding: 4px 8px;\n      margin: 8px -8px;\n      font-style: italic;\n    }\n    .actions {\n      padding: 16px;\n      border-top: 1px solid var(--ui-border, #ddd);\n      display: flex;\n      gap: 12px;\n      background: var(--ui-background, #f8f9fa);\n      position: sticky;\n      bottom: 0;\n    }\n    .btn {\n      padding: 10px 24px;\n      border: none;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      transition: background-color 0.15s, transform 0.1s;\n    }\n    .btn:hover {\n      transform: translateY(-1px);\n    }\n    .btn:active {\n      transform: translateY(0);\n    }\n    .btn-accept {\n      background: #22c55e;\n      color: white;\n    }\n    .btn-accept:hover {\n      background: #16a34a;\n    }\n    .btn-reject {\n      background: #ef4444;\n      color: white;\n    }\n    .btn-reject:hover {\n      background: #dc2626;\n    }\n    .btn-view {\n      background: var(--ui-background-secondary, #e5e7eb);\n      color: var(--text-color, #333);\n    }\n    .btn-view:hover {\n      background: var(--ui-background-tertiary, #d1d5db);\n    }\n    .loading {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 40px;\n      color: var(--text-secondary, #666);\n    }\n    .error {\n      padding: 16px;\n      background: #fee2e2;\n      color: #991b1b;\n      border-radius: 6px;\n      margin: 16px;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"title\">\n      <span class=\"title-icon\">\uD83D\uDCCB</span>\n      <span id=\"title\">Loading...</span>\n    </div>\n    <div class=\"target\">Target: <a href=\"#\" id=\"target-link\"><span id=\"target\"></span></a></div>\n    <div class=\"description\" id=\"description\"></div>\n    <div class=\"metadata\">\n      <span id=\"proposed-by\"></span> \u2022 <span id=\"created-at\"></span>\n    </div>\n  </div>\n  <div id=\"new-page-banner\" class=\"new-page-banner\" style=\"display:none\">\n    \uD83C\uDD95 NEW PAGE - This will create a new page\n  </div>\n  <div id=\"content\">\n    <div class=\"loading\">Loading proposal...</div>\n  </div>\n  <div class=\"actions\">\n    <button class=\"btn btn-accept\" onclick=\"acceptProposal()\">\u2713 Accept</button>\n    <button class=\"btn btn-reject\" onclick=\"rejectProposal()\">\u2717 Reject</button>\n    <button class=\"btn btn-view\" onclick=\"viewTarget()\">\uD83D\uDC41 View Target</button>\n  </div>\n\n  <script>\n    let meta = {};\n    let proposedContent = '';\n    let originalContent = '';\n\n    window.silverbullet.addEventListener(\"file-open\", async (event) => {\n      try {\n        const decoder = new TextDecoder();\n        const content = decoder.decode(event.detail.data);\n\n        // Parse frontmatter\n        const match = content.match(/^---\\\\n([\\\\s\\\\S]*?)\\\\n---\\\\n([\\\\s\\\\S]*)$/);\n        if (!match) {\n          showError('Invalid proposal file format');\n          return;\n        }\n\n        const [, frontmatter, body] = match;\n        meta = parseFrontmatter(frontmatter);\n        proposedContent = body.trim();\n\n        // Update UI\n        document.getElementById('title').textContent = meta.title || 'Untitled Proposal';\n        document.getElementById('target').textContent = meta.target_page || 'Unknown';\n        document.getElementById('target-link').href = '#';\n        document.getElementById('description').textContent = meta.description || '';\n        document.getElementById('proposed-by').textContent = 'Proposed by: ' + (meta.proposed_by || 'Unknown');\n        document.getElementById('created-at').textContent = formatDate(meta.created_at);\n\n        if (meta.is_new_page === 'true' || meta.is_new_page === true) {\n          document.getElementById('new-page-banner').style.display = 'flex';\n          showNewPageContent();\n        } else {\n          // Fetch original and render diff\n          try {\n            originalContent = await window.silverbullet.syscall('space.readPage', meta.target_page);\n            renderInlineDiff();\n          } catch (e) {\n            // Page might not exist (was deleted since proposal created)\n            document.getElementById('new-page-banner').style.display = 'flex';\n            document.getElementById('new-page-banner').innerHTML =\n              '\u26A0\uFE0F Original page not found - will create as new page';\n            showNewPageContent();\n          }\n        }\n      } catch (e) {\n        showError('Failed to load proposal: ' + e.message);\n      }\n    });\n\n    function parseFrontmatter(yaml) {\n      const meta = {};\n      yaml.split('\\\\n').forEach(line => {\n        const idx = line.indexOf(':');\n        if (idx > 0) {\n          const key = line.slice(0, idx).trim();\n          let value = line.slice(idx + 1).trim();\n          // Remove quotes if present\n          if ((value.startsWith('\"') && value.endsWith('\"')) ||\n              (value.startsWith(\"'\") && value.endsWith(\"'\"))) {\n            value = value.slice(1, -1);\n          }\n          meta[key] = value;\n        }\n      });\n      return meta;\n    }\n\n    function formatDate(isoString) {\n      if (!isoString) return '';\n      try {\n        const date = new Date(isoString);\n        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();\n      } catch {\n        return isoString;\n      }\n    }\n\n    function escapeHtml(text) {\n      const div = document.createElement('div');\n      div.textContent = text;\n      return div.innerHTML;\n    }\n\n    function showError(message) {\n      document.getElementById('content').innerHTML =\n        '<div class=\"error\">' + escapeHtml(message) + '</div>';\n    }\n\n    function showNewPageContent() {\n      document.getElementById('content').innerHTML =\n        '<div class=\"diff\">' + escapeHtml(proposedContent) + '</div>';\n    }\n\n    function renderInlineDiff() {\n      const origLines = originalContent.split('\\\\n');\n      const propLines = proposedContent.split('\\\\n');\n\n      // Use a simple LCS-based diff algorithm\n      const diff = computeDiff(origLines, propLines);\n\n      let html = '<div class=\"diff\">';\n      for (const line of diff) {\n        const escapedText = escapeHtml(line.text);\n        if (line.type === 'add') {\n          html += '<div class=\"diff-line diff-add\">' + escapedText + '</div>';\n        } else if (line.type === 'del') {\n          html += '<div class=\"diff-line diff-del\">' + escapedText + '</div>';\n        } else {\n          html += '<div class=\"diff-line diff-context\">' + escapedText + '</div>';\n        }\n      }\n      html += '</div>';\n\n      document.getElementById('content').innerHTML = html;\n    }\n\n    function computeDiff(orig, prop) {\n      // Simple line-by-line diff using longest common subsequence approach\n      const result = [];\n      const origSet = new Set(orig);\n      const propSet = new Set(prop);\n\n      let i = 0, j = 0;\n\n      while (i < orig.length || j < prop.length) {\n        if (i < orig.length && j < prop.length && orig[i] === prop[j]) {\n          // Lines match\n          result.push({ type: 'context', text: orig[i] });\n          i++;\n          j++;\n        } else if (i < orig.length && !propSet.has(orig[i])) {\n          // Line only in original (deleted)\n          result.push({ type: 'del', text: orig[i] });\n          i++;\n        } else if (j < prop.length && !origSet.has(prop[j])) {\n          // Line only in proposed (added)\n          result.push({ type: 'add', text: prop[j] });\n          j++;\n        } else if (i < orig.length) {\n          // Line in original but moved\n          result.push({ type: 'del', text: orig[i] });\n          i++;\n        } else {\n          // Line in proposed but moved\n          result.push({ type: 'add', text: prop[j] });\n          j++;\n        }\n      }\n\n      return result;\n    }\n\n    async function acceptProposal() {\n      if (!confirm('Apply this proposal to ' + meta.target_page + '?')) return;\n\n      try {\n        // Write proposed content to target page\n        await window.silverbullet.syscall('space.writePage', meta.target_page, proposedContent);\n\n        // Delete the proposal file (it's been applied)\n        const currentPage = await window.silverbullet.syscall('editor.getCurrentPage');\n        await window.silverbullet.syscall('space.deletePage', currentPage);\n\n        alert('Proposal accepted! Page updated.');\n        // Navigate to the target page\n        await window.silverbullet.syscall('editor.navigate', meta.target_page);\n      } catch (e) {\n        alert('Failed to apply proposal: ' + e.message);\n      }\n    }\n\n    async function rejectProposal() {\n      if (!confirm('Reject this proposal?')) return;\n\n      try {\n        const currentPage = await window.silverbullet.syscall('editor.getCurrentPage');\n        // Move to rejected folder - cron job will clean up after X days\n        const rejectedPath = currentPage.replace('_Proposals/', '_Proposals/_Rejected/');\n\n        // Read current content, update status, write to new location\n        const content = await window.silverbullet.syscall('space.readPage', currentPage);\n        const updatedContent = content.replace(/status: pending/, 'status: rejected');\n\n        await window.silverbullet.syscall('space.writePage', rejectedPath, updatedContent);\n        await window.silverbullet.syscall('space.deletePage', currentPage);\n\n        alert('Proposal rejected. It will be cleaned up automatically.');\n        await window.silverbullet.syscall('editor.navigate', 'Library/Proposals/Proposals');\n      } catch (e) {\n        alert('Failed to reject proposal: ' + e.message);\n      }\n    }\n\n    async function viewTarget() {\n      if (meta.target_page) {\n        try {\n          await window.silverbullet.syscall('editor.navigate', meta.target_page);\n        } catch (e) {\n          alert('Could not navigate: ' + e.message);\n        }\n      }\n    }\n  </script>\n</body>\n</html>\n    `\n  };\n}\n", "\nimport { setupMessageListener } from \"https://deno.land/x/silverbullet@2.3.0/client/plugos/worker_runtime.ts\";\n\n// Imports\nimport {editor as proposalEditor} from \"file:///workspaces/silverbullet-rag/library/Proposals/proposal_editor.ts\";\n\n\n// Function mapping\nconst functionMapping = {\n  proposalEditor: proposalEditor,\n\n};\n\n// Manifest\nconst manifest = {\n  \"name\": \"Proposals\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Review and manage proposed changes to your Silverbullet space\",\n  \"author\": \"silverbullet-rag\",\n  \"functions\": {\n    \"proposalEditor\": {\n      \"path\": \"./proposal_editor.ts:editor\",\n      \"editor\": [\n        \".proposal\"\n      ]\n    }\n  },\n  \"assets\": {}\n};\n\nexport const plug = {manifest, functionMapping};\n\nsetupMessageListener(functionMapping, manifest, self.postMessage);\n"],
  "mappings": "AAAO,SAASA,EAAaC,EAAuB,CAClD,IAAMC,EAAY,KAAKD,CAAC,EAClBE,EAAMD,EAAU,OAChBE,EAAQ,IAAI,WAAWD,CAAG,EAChC,QAASE,EAAI,EAAGA,EAAIF,EAAKE,IACvBD,EAAMC,CAAC,EAAIH,EAAU,WAAWG,CAAC,EAEnC,OAAOD,CACT,CAEO,SAASE,EAAaC,EAAqC,CAC5D,OAAOA,GAAW,WACpBA,EAAS,IAAI,YAAY,EAAE,OAAOA,CAAM,GAE1C,IAAIC,EAAS,GACPL,EAAMI,EAAO,WACnB,QAASF,EAAI,EAAGA,EAAIF,EAAKE,IACvBG,GAAU,OAAO,aAAaD,EAAOF,CAAC,CAAC,EAEzC,OAAO,KAAKG,CAAM,CACpB,CA6DA,IAAMC,EAAe,IAAI,WAAW,EAAE,ECzE/B,IAAMC,EAAN,KAAa,CAUlB,YACUC,EAAiB,GACjBC,EAAyB,IACjC,CAFQ,YAAAD,EACA,oBAAAC,EAER,KAAK,OAASD,EAGd,KAAK,gBAAkB,CACrB,IAAK,QAAQ,IAAI,KAAK,OAAO,EAC7B,KAAM,QAAQ,KAAK,KAAK,OAAO,EAC/B,KAAM,QAAQ,KAAK,KAAK,OAAO,EAC/B,MAAO,QAAQ,MAAM,KAAK,OAAO,EACjC,MAAO,QAAQ,MAAM,KAAK,OAAO,CACnC,EAEA,KAAK,aAAa,CACpB,CAzBQ,gBAOD,UAAwB,CAAC,EAoBxB,cAAqB,CAC3B,IAAME,EAAuBC,GACpB,IAAIC,IAAgB,CACzB,IAAMC,EAAe,KAAK,OAAS,CAAC,KAAK,OAAQ,GAAGD,CAAI,EAAIA,EAG5D,KAAK,gBAAgBD,CAAK,EAAE,GAAGE,CAAY,EAG3C,KAAK,WAAWF,EAAOC,CAAI,CAC7B,EAGF,QAAQ,IAAMF,EAAoB,KAAK,EACvC,QAAQ,KAAOA,EAAoB,MAAM,EACzC,QAAQ,KAAOA,EAAoB,MAAM,EACzC,QAAQ,MAAQA,EAAoB,OAAO,EAC3C,QAAQ,MAAQA,EAAoB,OAAO,CAC7C,CAEQ,WAAWC,EAA0BC,EAAmB,CAC9D,IAAME,EAAkB,CACtB,MAAAH,EACA,UAAW,KAAK,IAAI,EACpB,QAASC,EAAK,IAAKG,GAAQ,CACzB,GAAI,OAAOA,GAAQ,SACjB,OAAOA,EAET,GAAI,CACF,OAAO,KAAK,UAAUA,CAAG,CAC3B,MAAQ,CAEN,OAAO,OAAOA,CAAG,CACnB,CACF,CAAC,EAAE,KAAK,GAAG,CACb,EAEA,KAAK,UAAU,KAAKD,CAAK,EAGrB,KAAK,UAAU,OAAS,KAAK,gBAC/B,KAAK,UAAU,MAAM,CAEzB,CAKA,MAAM,aAAaE,EAAqBC,EAAgB,CAEtD,GADa,KAAK,UACT,OAAS,EAAG,CAEnB,IAAMC,EAAU,CAAC,GAAG,KAAK,SAAS,EAClC,KAAK,UAAY,CAAC,EAClB,GAAI,CAQF,GAAI,EAPS,MAAM,MAAMF,EAAa,CACpC,OAAQ,OACR,QAAS,CACP,eAAgB,kBAClB,EACA,KAAM,KAAK,UAAUE,EAAQ,IAAKJ,IAAW,CAAE,GAAGA,EAAO,OAAAG,CAAO,EAAE,CAAC,CACrE,CAAC,GACS,GACR,MAAM,IAAI,MAAM,+BAA+B,CAEnD,OAASE,EAAQ,CACf,QAAQ,KAAK,gCAAiCA,EAAE,OAAO,EAEvD,KAAK,UAAU,QAAQ,GAAGD,CAAO,CACnC,CACF,CACF,CACF,EAGIE,EAEG,SAASC,EAAWb,EAAiB,GAAY,CACtD,OAAAY,EAAe,IAAIb,EAAOC,CAAM,EACzBY,CACT,CCvGA,IAAIE,EAAqBC,GAAkC,CACzD,MAAM,IAAI,MAAM,qBAAqB,CACvC,EAUMC,EAAqB,OAAO,OAAW,KAE3C,OAAO,WAAW,cAAkB,IAElC,OAAO,KAAS,MAElB,KAAK,KAAO,CACV,KAAM,CAAC,EAEP,MAAO,CACL,KAAM,QACR,EACA,IAAK,CAEH,KAAM,CACN,CACF,CACF,GAGF,IAAMC,EAAkB,IAAI,IAQxBC,EAAe,EAEfF,IACF,WAAW,QAAU,MAAOG,KAAiBC,IACpC,MAAM,IAAI,QAAQ,CAACC,EAASC,IAAW,CAC5CJ,IACAD,EAAgB,IAAIC,EAAc,CAAE,QAAAG,EAAS,OAAAC,CAAO,CAAC,EACrDR,EAAkB,CAChB,KAAM,MACN,GAAII,EACJ,KAAAC,EACA,KAAAC,CACF,CAAC,CACH,CAAC,GAIE,SAASG,EAEdC,EACAC,EACAC,EACA,CACKV,IAKLF,EAAoBY,EACpB,KAAK,iBAAiB,UAAYC,GAAmC,EAClE,SAAY,CACX,IAAMC,EAAOD,EAAM,KACnB,OAAQC,EAAK,KAAM,CACjB,IAAK,MACH,CACE,IAAMC,EAAKL,EAAgBI,EAAK,IAAK,EACrC,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,wBAAwBD,EAAK,IAAI,EAAE,EAErD,GAAI,CACF,IAAME,EAAS,MAAM,QAAQ,QAAQD,EAAG,GAAID,EAAK,MAAQ,CAAC,CAAE,CAAC,EAC7Dd,EAAkB,CAChB,KAAM,OACN,GAAIc,EAAK,GACT,OAAQE,CACV,CAAsB,CACxB,OAASC,EAAQ,CACf,QAAQ,MACN,2DACAH,EAAK,KACL,SACAG,EAAE,OACJ,EACAjB,EAAkB,CAChB,KAAM,OACN,GAAIc,EAAK,GACT,MAAOG,EAAE,OACX,CAAC,CACH,CACF,CACA,MACF,IAAK,OACH,CACE,IAAMC,EAAYJ,EAAK,GACjBK,EAAShB,EAAgB,IAAIe,CAAS,EAC5C,GAAI,CAACC,EACH,MAAM,MAAM,oBAAoB,EAElChB,EAAgB,OAAOe,CAAS,EAC5BJ,EAAK,MACPK,EAAO,OAAO,IAAI,MAAML,EAAK,KAAK,CAAC,EAEnCK,EAAO,QAAQL,EAAK,MAAM,CAE9B,CAEA,KACJ,CACF,GAAG,EAAE,MAAM,QAAQ,KAAK,CAC1B,CAAC,EAEDd,EAAkB,CAChB,KAAM,WACN,SAAAW,CACF,CAAC,EACDS,EAAW,IAAIT,EAAS,IAAI,QAAQ,EACtC,CAEA,eAAsBU,EACpBC,EACAC,EAC+B,CAC/B,GAAI,OAAOD,GAAY,SAAU,CAC/B,IAAME,EAAO,IAAI,WAAW,MAAMF,EAAQ,YAAY,CAAC,EACjDG,EAAcD,EAAK,OAAS,EAAIE,EAAaF,CAAI,EAAI,OAC3DD,EAAU,CACR,OAAQD,EAAQ,OAChB,QAAS,OAAO,YAAYA,EAAQ,QAAQ,QAAQ,CAAC,EACrD,WAAYG,CACd,EACAH,EAAUA,EAAQ,GACpB,CACA,OAAO,QAAQ,qBAAsBA,EAASC,CAAO,CACvD,CAGA,WAAW,YAAc,WAAW,MAG7B,SAASI,GAAmB,CAEjC,WAAW,MAAQ,eACjBL,EACAM,EACmB,CACnB,IAAMH,EAAcG,GAAQA,EAAK,KAC7BF,EACA,IAAI,WAAW,MAAO,IAAI,SAASE,EAAK,IAAI,EAAG,YAAY,CAAC,CAC9D,EACE,OACEC,EAAI,MAAMR,EACdC,EACAM,GAAQ,CACN,OAAQA,EAAK,OACb,QAASA,EAAK,QACd,WAAYH,CACd,CACF,EAEA,OAAO,IAAI,SACRI,EAAE,WAAaC,EAAaD,EAAE,UAAU,EAAI,KAC7C,CACE,OAAQA,EAAE,OACV,QAASA,EAAE,OACb,CACF,CACF,CACF,CAEI3B,GACFyB,EAAiB,EC1LnB,eAAsBI,GAAoC,CACxD,MAAO,CACL,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KA+YR,CACF,CCjZA,IAAMC,EAAkB,CACtB,eAAgBC,CAElB,EAGMC,EAAW,CACf,KAAQ,YACR,QAAW,QACX,YAAe,gEACf,OAAU,mBACV,UAAa,CACX,eAAkB,CAChB,KAAQ,8BACR,OAAU,CACR,WACF,CACF,CACF,EACA,OAAU,CAAC,CACb,EAEaC,EAAO,CAAC,SAAAD,EAAU,gBAAAF,CAAe,EAE9CI,EAAqBJ,EAAiBE,EAAU,KAAK,WAAW",
  "names": ["base64Decode", "s", "binString", "len", "bytes", "i", "base64Encode", "buffer", "binary", "fixedCounter", "Logger", "prefix", "maxCaptureSize", "createPatchedMethod", "level", "args", "prefixedArgs", "entry", "arg", "logEndpoint", "source", "logCopy", "e", "globalLogger", "initLogger", "workerPostMessage", "_msg", "runningAsWebWorker", "pendingRequests", "syscallReqId", "name", "args", "resolve", "reject", "setupMessageListener", "functionMapping", "manifest", "postMessageFn", "event", "data", "fn", "result", "e", "syscallId", "lookup", "initLogger", "sandboxFetch", "reqInfo", "options", "body", "encodedBody", "base64Encode", "monkeyPatchFetch", "init", "r", "base64Decode", "editor", "functionMapping", "editor", "manifest", "plug", "setupMessageListener"]
}
