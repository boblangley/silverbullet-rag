version: '3.8'

services:
  # Unified server: gRPC + MCP + file watcher in a single process
  # This avoids database locking issues by sharing a single DB connection
  silverbullet-rag:
    # Use pre-built image from GHCR (comment out 'build' and uncomment 'image' to use)
    # image: ghcr.io/YOUR_USERNAME/silverbullet-rag:latest
    build: .
    container_name: silverbullet-rag
    volumes:
      # Mount the Silverbullet space (same as Silverbullet container)
      # Write access needed for proposals and library installation
      - silverbullet-space:/space
      # Mount database directory
      - ladybug-db:/data
    ports:
      # MCP Streamable HTTP transport
      - "8000:8000"
      # gRPC for hooks
      - "50051:50051"
      # Health check endpoint (optional, for external monitoring)
      # - "8080:8080"
    environment:
      - DB_PATH=/data/ladybug
      - SPACE_PATH=/space
      - GRPC_PORT=50051
      - MCP_PORT=8000
      - HEALTH_PORT=8080
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

volumes:
  silverbullet-space:
    external: true  # Should match your Silverbullet volume
  ladybug-db:
