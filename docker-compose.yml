version: '3.8'

services:
  # Unified server: gRPC + MCP + file watcher in a single process
  # This avoids database locking issues by sharing a single DB connection
  silverbullet-rag:
    # Use pre-built image from GHCR (comment out 'build' and uncomment 'image' to use)
    # image: ghcr.io/YOUR_USERNAME/silverbullet-rag:latest
    build: .
    container_name: silverbullet-rag
    volumes:
      # Mount the Silverbullet space (same as Silverbullet container)
      - silverbullet-space:/space:ro
      # Mount database directory
      - ladybug-db:/data
    ports:
      # MCP Streamable HTTP transport
      - "8000:8000"
      # gRPC for hooks
      - "50051:50051"
    environment:
      - DB_PATH=/data/ladybug
      - SPACE_PATH=/space
      - GRPC_PORT=50051
      - MCP_PORT=8000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
    restart: unless-stopped
    command: python -m server

volumes:
  silverbullet-space:
    external: true  # Should match your Silverbullet volume
  ladybug-db:
